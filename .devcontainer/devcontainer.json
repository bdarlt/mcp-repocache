// .devcontainer/devcontainer.json
{
  "build": {
    "dockerfile": "Dockerfile",
    "args": {
      "_DEV_CONTAINERS_BUILD_TMPFS_SIZE": "256m",
      "_CONTAINER_BUILD_TMPFS_SIZE": "512m"
    }
  },
  "mounts": [
    "source=${localWorkspaceFolder}/.env.local,target=/home/pn/.env,readonly,type=bind"
  ],
  // 2. make VS Code load it automatically
  "remoteEnv": {
    "MOONSHOT_API_KEY": "${localEnv:MOONSHOT_API_KEY}"
  },
  "overrideFeatureInstallOrder": [
    "ghcr.io/devcontainers/features/common-utils",
    "ghcr.io/devcontainers-contrib/features/zsh-plugins"
  ],
  "features": {
    // Let the official common-utils feature install zsh + oh-my-zsh
    //    for the remoteUser.
    "ghcr.io/devcontainers/features/common-utils:2": {
      "installZsh": false,
      "installOhMyZsh": true,
      "upgradePackages": true,
      "username": "pn" // same as remoteUser below
    },
    /* 2.  (Optional) add syntax-highlighting, auto-suggestions, etc. */
    "ghcr.io/devcontainers-extra/features/zsh-plugins": {
      "plugins": "git zsh-autosuggestions zsh-syntax-highlighting",
      "omzTemplates": "true"
    }
  },

  "runArgs": [
    "--cap-add=NET_ADMIN",
    "--cap-add=NET_RAW",
    "--tmpfs",
    "/tmp:exec,mode=1777"
  ],

  "customizations": {
    "vscode": {
      "extensions": [
        "anthropic.claude-code",
        "dbaeumer.vscode-eslint",
        "esbenp.prettier-vscode",
        "ms-python.black-formatter",
        "eamodio.gitlens"
      ],
      "settings": {
        "editor.formatOnSave": true,
        "[javascript]": { "editor.defaultFormatter": "esbenp.prettier-vscode" },
        "[typescript]": { "editor.defaultFormatter": "esbenp.prettier-vscode" },
        "[javascriptreact]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode"
        },
        "[typescriptreact]": {
          "editor.defaultFormatter": "esbenp.prettier-vscode"
        },
        "[python]": {
          "editor.defaultFormatter": "ms-python.black-formatter"
        },
        "editor.codeActionsOnSave": {
          "source.fixAll.eslint": "explicit"
        },
        "terminal.integrated.defaultProfile.linux": "zsh"
      }
    }
  },

  "remoteUser": "pn",
  "containerEnv": {
    "NODE_OPTIONS": "--max-old-space-size=4096",
    "CLAUDE_CONFIG_DIR": "/home/pn/.claude"
  },
  /* create the Claude directory so the extension never complains */
  "postCreateCommand": "python -m pip install --upgrade pip python-dotenv 'black>=24.0' && mkdir -p ${HOME}/.claude"
}
